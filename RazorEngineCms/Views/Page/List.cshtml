@model RazorEngineCms.Models.PageList

@{
    ViewBag.Title = "List";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>Pages</h2>


@if (Model.Count == 0) // Show message if no pages
{
    <p>No pages have been created. <a href="/Page/New">Create a new page?</a></p>
}
else // Show Page List Table
{
    <div id="alertMsgs"></div>
    <table class="table">
        <thead>
            <tr>
                <th>Page ID</th>
                <th>Page Name</th>
                <th>Page Section</th>
                <th>&nbsp;</th>
                <th>&nbsp;</th>
                <th>&nbsp;</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var page in Model)
            {
                <tr>
                    <td>@page.Id</td>
                    <td>@page.Name</td>
                    <td>@page.Section</td>
                    <td><a href="/Page/View/@page.Name/@page.Section" target="_blank">Preview</a></td>
                    <td><a href="/Page/Edit/@page.Name/@page.Section">Edit</a></td>
                    <td><a href="#" data-pagename="@page.Name" data-pagesection="@page.Section" class="delete-page">Delete</a></td>

                </tr>
            }
        </tbody>
    </table>
}

    @Html.Partial("_ConfiromDeleteModalPartial");

@section Scripts {
    <script type="text/javascript" src="~/Scripts/page.js"></script>
    <script type="text/javascript">
        "use strict";
        var page = new Page();
        // called on confirmation of delete modal
        // deletes a page using POST: /Page/Delete/{name}/{section}
        function confirmDelete(sessionKey) {
            if (sessionKey != null) {
                var storedPage = JSON.parse(sessionStorage.getItem(sessionKey));
                var deleteStatus = page.delete(storedPage.pageName, storedPage.pageSection, "#alertMsgs");
                if (deleteStatus) {
                    $("a[data-pagename=\"" + storedPage.pageName + "\"][data-pagesection=\"" + storedPage.pageSection + "\"]").parent().parent().remove(); // remove row
                } // end if deleteStatus true
                sessionStorage.removeItem(sessionKey);
            } // end if pageName != null
            $("#deletePageModal").modal("hide");
        }
        $(function () {
            $("#confirmDeletePage").click(function () {
                var sessionKey = $(this).attr("data-sessionkey");;
                confirmDelete(sessionKey);
            });
            $("a.delete-page").click(function(e) {
                e.preventDefault();
                var pageItem = {
                    pageName : $(this).attr("data-pagename"),
                    pageSection : $(this).attr("data-pagesection"),
                    thisSel : $(this)
                };
                var sessionKey = "/" + pageItem.pageName + "/" + pageItem.pageSection;
                $("#deletePageName").text(sessionKey);
                $("#confirmDeletePage").attr("data-sessionkey", sessionKey);
                sessionStorage.setItem(sessionKey, JSON.stringify(pageItem));
                $("#deletePageModal").modal("show");
            });
        }); // end document ready function
    </script>
}